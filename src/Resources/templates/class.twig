<?php

namespace Graviton\MigrationKit\Migrations\MongoDB;

use AntiMattr\MongoDB\Migrations\AbstractMigration;
use Doctrine\MongoDB\Database;
use JsonPath\JsonObject;
use MongoDB;

/**
 * Migration {{ migrationId }}
 * This migration is automatically generated.
 */
class Version{{ migrationId }} // extends AbstractMigration
{

    /**
    * @var string
    */
    private $collection = '{{ exposedEntity }}';

    /**
    * @return string
    */
    public function getDescription()
    {
        return 'autogenerated migration';
    }


    public function up(/* Database */ $db)
    {
        $col = $db->createCollection($this->collection);
        foreach ($col->find([]) as $obj) {
            $this->migrateSingleEntity(new JsonObject($obj, true), $col);
        }
    }

    private function migrateSingleEntity(JsonObject $rec, $collection)
    {
        $isDirty = false;

        {{ partials }}

        // save if modified
        if ($isDirty) {
            $recordId = (string) $rec->get('$["_id"]');
            if (!is_string($recordId)) {
                throw new \LogicException('Could not determine record id!');
            }

            $collection->update(['_id' => $recordId], $rec->getValue());
            echo "updated id ".$recordId;
            //$collection->findAndUpdate(['_id' => $recordId], $rec->getValue());
        }
    }

    /**
    * down
    *
    * @param Database $db database to migrate
    *
    * @return void
    */
    public function down(Database $db)
    {
        // this is not supported
    }

    private $migData = '{{ migData }}';
}
